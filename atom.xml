<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>YiShao&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://dongjiang1989.github.io/"/>
  <updated>2020-01-15T07:03:07.226Z</updated>
  <id>https://dongjiang1989.github.io/</id>
  
  <author>
    <name>dongjiang1899</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CNI</title>
    <link href="https://dongjiang1989.github.io/2020/01/15/CNI/"/>
    <id>https://dongjiang1989.github.io/2020/01/15/CNI/</id>
    <published>2020-01-15T02:45:57.000Z</published>
    <updated>2020-01-15T07:03:07.226Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>CNI（容器网络接口）是一个规范和库，用于编写用于在Linux容器中配置网络接口的插件以及许多受支持的插件组成。</p><p>CNI包括几部分： </p><blockquote><p>golang SDK Lib, 用于集成实现网络通信接口；</p></blockquote><blockquote><p>Template，用于生成自定义的CNI插件，标准代码工程；</p></blockquote><blockquote><p>标准Document，包括社区公约、描述、roadmaps、milestone等</p></blockquote><h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><h3 id="cnitool-介绍"><a href="#cnitool-介绍" class="headerlink" title="cnitool 介绍"></a>cnitool 介绍</h3><p>cnitool是将已经编译完成的的容器网络插件Adapter，添加到VM中或者PM中。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">EnvCNIPath        = <span class="string">"CNI_PATH"</span>   <span class="comment">//CNI Adapter bin文件路径（bin的编译需要去掉ggo）</span></span><br><span class="line">EnvNetDir         = <span class="string">"NETCONFPATH"</span>  <span class="comment">//部署（添加、删除、检查）adapter需要的json配置文件路径</span></span><br><span class="line">EnvCapabilityArgs = <span class="string">"CAP_ARGS"</span>  <span class="comment">// CAP 参数</span></span><br><span class="line">EnvCNIArgs        = <span class="string">"CNI_ARGS"</span>  <span class="comment">// adapter 外部传递的参数，一般不用，将args放在json文件中</span></span><br><span class="line">EnvCNIIfname      = <span class="string">"CNI_IFNAME"</span>  <span class="comment">// 设置的容器网卡名称，如eth0</span></span><br><span class="line"></span><br><span class="line">DefaultNetDir = <span class="string">"/etc/cni/net.d"</span> <span class="comment">// 默认CNI 插件路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下部分是 插件 添加方式</span></span><br><span class="line">CmdAdd   = <span class="string">"add"</span></span><br><span class="line">CmdCheck = <span class="string">"check"</span></span><br><span class="line">CmdDel   = <span class="string">"del"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="插件使用"><a href="#插件使用" class="headerlink" title="插件使用"></a>插件使用</h3><p>准备二进制插件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/containernetworking/plugins</span><br><span class="line">go build ptp -o myptp</span><br></pre></td></tr></table></figure><p>准备网络配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> `</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"cniVersion"</span>: <span class="string">"0.4.0"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"myptp"</span>,</span><br><span class="line"><span class="string">"type"</span>: <span class="string">"ptp"</span>,  //veth pair</span><br><span class="line"><span class="string">"ipMasq"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"ipam"</span>: &#123;</span><br><span class="line"><span class="string">"type"</span>: <span class="string">"host-local"</span>,</span><br><span class="line"><span class="string">"subnet"</span>: <span class="string">"172.16.29.0/24"</span>,</span><br><span class="line"><span class="string">"routes"</span>: [&#123;</span><br><span class="line"><span class="string">"dst"</span>: <span class="string">"0.0.0.0/0"</span></span><br><span class="line">&#125;]</span><br><span class="line">&#125;</span><br><span class="line">&#125;` &gt; /etc/cni/net.d/myptp.conflist</span><br></pre></td></tr></table></figure><p>准备好配置后部署容器网络：</p><p>第一步：创建网络Namespace， 添加名称为mytest_network</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip netns add mytest_network</span><br></pre></td></tr></table></figure><p>第二步：添加容器网络myptp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo CNI_PATH=/etc/cni/net.d/ cnitool add myptp /var/run/netns/mytest_network</span><br></pre></td></tr></table></figure><p>第三步：调测网络</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ip -n mytest_network addr</span><br><span class="line">sudo ip netns <span class="built_in">exec</span> mytest_network ping -c 1 4.2.2.2</span><br></pre></td></tr></table></figure><p>最后，清理网络</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo CNI_PATH=./etc/cni/net.d/ cnitool del myptp /var/run/netns/mytest_network</span><br><span class="line">sudo ip netns del mytest_network</span><br></pre></td></tr></table></figure><h3 id="cnitool调用插件"><a href="#cnitool调用插件" class="headerlink" title="cnitool调用插件"></a>cnitool调用插件</h3>]]></content>
    
    <summary type="html">
    
      Container Network Interface - networking for Linux containers
    
    </summary>
    
    
    
      <category term="K8S, Container Network Interface" scheme="https://dongjiang1989.github.io/tags/K8S-Container-Network-Interface/"/>
    
  </entry>
  
</feed>
